<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PROTO-BAI - DEV Mode Visualization</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #8b5fbf 0%, #60a5fa 100%);
        height: 100vh;
        overflow: hidden;
      }

      .container {
        display: flex;
        height: 100vh;
        padding: 20px;
        gap: 20px;
      }

      .sidebar {
        overflow: hidden; /* clip to rounded corners */
        scrollbar-width: none;
        width: 280px;
        background: #ffffff; /* fully opaque to avoid bleed-through */
        border-radius: 20px;
        padding: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        position: relative;
        display: flex;
        flex-direction: column;
      }

      /* Inner scroll container to preserve scrolling while clipping corners */
      .sidebar-inner {
        flex: 1;
        min-height: 0; /* allow child to shrink properly within flex container */
        overflow: auto;
        padding-right: 6px; /* space for scrollbar */
      }

      /* Removed masking overlay on sidebar; structure now prevents peeking */

      .modules-section {
        position: relative;
      }

      /* No extra margin needed; profile is outside the scroll container */
      .modules-section .module-btn:first-of-type {
        margin-top: 0;
      }

      .module-btn {
        position: relative;
      }

      .profile-section {
        background: #ffffff; /* solid background to avoid showing menu behind */
        border-radius: 15px;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
        /* profile stays fixed above the scroll container; sticky optional */
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(6px);
        border-bottom: 1px solid rgba(0,0,0,0.06);
        /* no extra white mask edge needed */
      }

      /* Removed profile masks; not needed with structured layout */

      .profile-pic {
        font-size: 40px;
        margin-bottom: 10px;
      }

      .user-info h3 {
        color: #2d3748;
        margin-bottom: 5px;
      }

      .status {
        color: #10b981;
        font-size: 12px;
      }

      .modules-section h4 {
        color: #2d3748;
        margin: 20px 0 15px 0;
        font-size: 16px;
      }

      .module-btn {
        width: 100%;
        padding: 12px 20px;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        border-radius: 12px;
        color: #2d3748;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
      }

      .module-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .command {
        color: #4f46e5;
        cursor: pointer;
        text-decoration: underline;
      }

      .command:hover {
        color: #4338ca;
      }
      

      .demo-queries {
        margin-top: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .demo-query {
        display: inline-block;
        margin: 3px;
        padding: 5px 10px;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        color: white;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .demo-query:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }

      .settings-section {
        margin-top: 20px;
      }

      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .setting-row label {
        color: #2d3748;
        font-size: 14px;
      }

      select {
        padding: 5px 10px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.8);
        color: #2d3748;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .chat-area {
        flex: 1;
        scrollbar-width: none;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 20px;
        overflow-y: auto;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .welcome-message {
        text-align: center;
        padding: 40px 20px;
      }

      .welcome-message h1 {
        color: #8b5fbf;
        font-size: 32px;
        margin-bottom: 15px;
      }

      .welcome-message p {
        color: #2d3748;
        font-size: 16px;
        margin-bottom: 10px;
      }

      .dev-info {
        color: #6b7280;
        font-size: 14px;
        line-height: 1.6;
      }

      .message {
        margin-bottom: 15px;
        padding: 15px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.5);
      }

      .message-header {
        font-weight: bold;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-message .message-header {
        color: #2563eb;
      }

      .ai-message .message-header {
        color: #8b5fbf;
      }

      .system-message .message-header {
        color: #ae4ae3;
      }

      .timestamp {
        font-size: 12px;
        color: #7c95bf;
        font-weight: normal;
      }

      .command {
        color: #4f46e5;
        cursor: pointer;
        text-decoration: underline;
      }

      .command:hover {
        color: #4338ca;
      }

      .demo-queries {
        margin-top: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }

      .demo-query {
        display: inline-block;
        margin: 3px;
        padding: 5px 10px;
        background: rgba(99, 102, 241, 0.2);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 15px;
        color: #c7d2fe;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .demo-query:hover {
        background: rgba(99, 102, 241, 0.3);
        transform: translateY(-1px);
      }

      .input-area {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 15px;
        display: flex;
        scrollbar-width: none;
        gap: 10px;
        align-items: center;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .voice-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: #ec4899;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .voice-btn:hover {
        background: #db2777;
        transform: scale(1.05);
      }

      .text-input {
        flex: 1;
        padding: 15px;
        border: none;
        background: transparent;
        font-size: 14px;
        color: #2d3748;
        outline: none;
      }

      .text-input::placeholder {
        color: #9ca3af;
      }

      .send-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        background: #8b5fbf;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .send-btn:hover {
        background: #7c3aed;
        transform: scale(1.05);
      }

      .typing-indicator {
        display: inline-block;
        color: #8b5fbf;
        font-style: italic;
        animation: blink 1.5s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }

        51%,
        100% {
          opacity: 0.3;
        }
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Profile Section -->
        <div class="profile-section">
          <div class="profile-pic">ü§ñ</div>
          <div class="user-info">
            <h3>User: Guest</h3>
            <div class="status">Status: Online</div>
          </div>
        </div>

        <div class="sidebar-inner">
          <!-- Modules Section -->
          <div class="modules-section">
            <h4>Modules</h4>
            <button class="module-btn" onclick="backToNormal()">
              <span style="font-size: 18px">‚¨Ö</span> Back to Normal
            </button>
            <button class="module-btn" onclick="activateModule('file-explorer')">
              <span style="font-size: 18px">üìÅ</span> File Explorer
            </button>
            <button class="module-btn" onclick="activateModule('web-crawler')">
              <span style="font-size: 18px">üåê</span> Web Crawler
            </button>
            <button class="module-btn" onclick="activateModule('github-search')">
              <span style="font-size: 18px">üêô</span> GitHub Search
            </button>
            <button class="module-btn" onclick="activateModule('ticket-booking')">
              <span style="font-size: 18px">üé´</span> Ticket Booking
            </button>
            <button class="module-btn" onclick="activateModule('ai-sync')">
              <span style="font-size: 18px">ü§ñ</span> AI Sync
            </button>
            <button class="module-btn" onclick="activateModule('error-solver')">
              <span style="font-size: 18px">üîß</span> Error Solver
            </button>
            <button class="module-btn" onclick="activateModule('python-docs')">
              <span style="font-size: 18px">üêç</span> Python Documentation
            </button>
          </div>

          <!-- Settings Section -->
          <div class="settings-section">
            <h4>Settings</h4>
            <div class="setting-row">
              <label>Theme:</label>
              <select onchange="changeTheme(this.value)">
                <option value="fairy-tail">Fairy Tail</option>
                <option value="ocean-breeze">Ocean Breeze</option>
                <option value="sunset-glow">Sunset Glow</option>
              </select>
            </div>
            <div class="setting-row">
              <label>Voice:</label>
              <select onchange="changeVoice(this.value)">
                <option value="girl-soft">Girl Soft</option>
                <option value="male-professional">Male Professional</option>
                <option value="neutral-calm">Neutral Calm</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
          <div class="welcome-message">
            <h1>ü§ñ Welcome to PROTO-BAI!</h1>
            <p>Your intelligent assistant with self-learning capabilities.</p>
            <div class="dev-info">
              üéØ I learn from every interaction<br />
              üí¨ Ask me anything using voice or text<br />
              üîß Currently running in <strong>DEVELOPMENT</strong> mode
            </div>
          </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
          <button class="voice-btn" onclick="toggleVoice()" id="voiceBtn">
            üé§
          </button>
          <input
            type="text"
            class="text-input"
            placeholder="Ask me anything..."
            id="textInput"
            onkeypress="handleKeyPress(event)"
          />
          <button class="send-btn" onclick="sendMessage()">‚ñ∂</button>
        </div>
      </div>
    </div>

    <script>
      let isListening = false;
      let messageCount = 0;
      let errorSolverActive = false; // Error Solver mode flag
      let activeModule = null; // Track which module is active

      function getCurrentTime() {
        return new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      function addMessage(sender, message, type = "user") {
        const chatArea = document.getElementById("chatArea");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}-message`;

        // Coerce message to string safely
        const safeMsg =
          typeof message === "string"
            ? message
            : message == null
            ? ""
            : (() => {
                try {
                  return JSON.stringify(message);
                } catch (_) {
                  return String(message);
                }
              })();

        messageDiv.innerHTML = `
    <div class="message-header">
        ${sender} <span class="timestamp">(${getCurrentTime()})</span>
    </div>
    <div>${safeMsg.replace(/\n/g, "<br>")}</div>
`;

        chatArea.appendChild(messageDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
      }

      async function sendMessageLegacyUnused() {
        const input = document.getElementById("textInput");
        const message = input.value.trim();

        if (!message) return;

        // Add user message
        addMessage("You", message, "user");
        input.value = "";

        // Show typing indicator
        showTypingIndicator();

        try {
          // Check if this is a Python docs command
          const lowerMsg = message.toLowerCase();
          if (
            lowerMsg.startsWith("python ") ||
            lowerMsg.startsWith("help ") ||
            lowerMsg.startsWith("python_help ")
          ) {
            // Process Python documentation command
            await processPythonCommand(message);
          } else {
            // Default response for other messages
            setTimeout(() => {
              hideTypingIndicator();
              const responses = [
                "ü§ñ (Mock Mode) I would help you with that! This is a development mode response.",
                "üìÅ (Mock) I would analyze your files and provide insights. Enable production mode for full functionality.",
                "üåê (Mock) I would search the web and extract information for you. This requires production mode.",
                "üîß (Mock) I would debug and solve your coding problems. Full debugging available in production mode.",
                "üéØ (Mock) I'm learning from our conversation! In production mode, I would provide more detailed responses.",
              ];
              const randomResponse =
                responses[Math.floor(Math.random() * responses.length)];
              addMessage("PROTO-BAI", randomResponse, "ai");
            }, 200);
          }
        } catch (error) {
          console.error("Error processing message:", error);
          hideTypingIndicator();
          addMessage(
            "PROTO-BAI",
            "Sorry, something went wrong while processing your request.",
            "ai"
          );
        }
      }

      function showTypingIndicator() {
        // Disabled: no thinking indicator
        return;
      }

      function hideTypingIndicator() {
        const typingIndicator = document.getElementById("typingIndicator");
        if (typingIndicator) {
          typingIndicator.remove();
        }
      }

      // Create or update a chat message by a specific id (used for streaming)
      function addMessageWithId(sender, message, type = "ai", id) {
        const chatArea = document.getElementById("chatArea");
        let messageDiv = id ? document.getElementById(id) : null;
        if (!messageDiv) {
          messageDiv = document.createElement("div");
          messageDiv.className = `message ${type}-message`;
          if (id) messageDiv.id = id;
          chatArea.appendChild(messageDiv);
        }

        // Coerce message to string safely
        const safeMsg =
          typeof message === "string"
            ? message
            : message == null
            ? ""
            : (() => {
                try {
                  return JSON.stringify(message);
                } catch (_) {
                  return String(message);
                }
              })();

        messageDiv.innerHTML = `
    <div class="message-header">
        ${sender} <span class="timestamp">(${getCurrentTime()})</span>
    </div>
    <div>${safeMsg.replace(/\n/g, "<br>")}</div>
`;
        chatArea.scrollTop = chatArea.scrollHeight;
        return messageDiv.id || id;
      }

      function toggleVoice() {
        const voiceBtn = document.getElementById("voiceBtn");

        if (!isListening) {
          isListening = true;
          voiceBtn.textContent = "üî¥";
          voiceBtn.style.background = "#EF4444";
          addMessage("System", "üé§ Listening... Speak now!", "system");

          // Simulate voice recognition (faster)
          setTimeout(() => {
            isListening = false;
            voiceBtn.textContent = "üé§";
            voiceBtn.style.background = "#EC4899";

            // Simulate recognized speech
            const voiceInputs = [
              "Hello PROTO-BAI",
              "What can you do?",
              "Help me with coding",
              "Tell me about yourself",
            ];
            const randomInput =
              voiceInputs[Math.floor(Math.random() * voiceInputs.length)];
            addMessage("You (Voice)", randomInput, "user");

            // Trigger AI response (faster, no typing indicator)
            showTypingIndicator();
            setTimeout(() => {
              hideTypingIndicator();
              addMessage(
                "PROTO-BAI",
                "üé§ (Mock Voice) I heard you clearly! In production mode, I would provide full voice interaction.",
                "ai"
              );
            }, 200);
          }, 800);
        }
      }

      // Python documentation search functionality
      const pythonDocs = {
        search: async function (query) {
          try {
            const response = await fetch(
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyAWNPb5bgI0HgO9Sgsbc4BLuzqD0tzlQ54",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        {
                          text: `Search Python documentation for: ${query}`,
                        },
                      ],
                    },
                  ],
                }),
              }
            );
            const data = await response.json();
            return data.candidates &&
              data.candidates[0] &&
              data.candidates[0].content
              ? data.candidates[0].content.parts[0].text
              : `Error: ${data.error || "Unknown error"}`;
          } catch (error) {
            console.error("Python docs error:", error);
            return "Failed to connect to Python documentation service. Make sure the server is running.";
          }
        },

        getHelp: async function (topic) {
          try {
            const response = await fetch(
              "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyAWNPb5bgI0HgO9Sgsbc4BLuzqD0tzlQ54",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        {
                          text: `Get help with Python topic: ${topic}`,
                        },
                      ],
                    },
                  ],
                }),
              }
            );
            const data = await response.json();
            return data.candidates &&
              data.candidates[0] &&
              data.candidates[0].content
              ? data.candidates[0].content.parts[0].text
              : `Error: ${data.error || "Unknown error"}`;
          } catch (error) {
            console.error("Python help error:", error);
            return "Failed to get Python help. Make sure the server is running.";
          }
        },

        demoQueries: [
          "list comprehension",
          "dictionary methods",
          "decorators",
          "context managers",
          "generators",
          "async/await",
        ],

        demoTopics: ["list", "dict", "os.path", "datetime", "json", "re"],
      };

      // Process Python documentation commands
      async function processPythonCommand(command) {
        const lowerCmd = command.toLowerCase();
        let response = "";

        if (lowerCmd.startsWith("python ")) {
          const query = command.substring(7).trim();
          response = await pythonDocs.search(query);
        } else if (lowerCmd.startsWith("help ")) {
          const topic = command.substring(5).trim();
          response = await pythonDocs.getHelp(topic);
        } else if (lowerCmd.startsWith("python_help ")) {
          const topic = command.substring(11).trim();
          response = await pythonDocs.getHelp(topic);
        } else {
          response =
            'Invalid Python documentation command. Try "python <query>" or "help <topic>"';
        }

        addMessage("PROTO-BAI", response, "ai");
      }

      // Error Solver: analyze error logs/messages and propose fixes
      async function processErrorSolver(inputText) {
        // Quick exit command
        const lower = inputText.trim().toLowerCase();
        if (lower === "exit error solver" || lower === "exit" || lower === "quit") {
          errorSolverActive = false;
          addMessage("System", "üö™ Exited Error Solver mode.", "system");
          return;
        }

        const prompt = `You are a senior debugging assistant. Given an error/stack trace or failure description, do the following:

Detect and state the most likely language/framework/tooling (e.g., React, Next.js, Node, Python, Django, Flask, Java, Spring, Git/GitHub Actions).

Output using these sections (short and actionable):
1) Root cause: one or two lines.
2) How to fix: concrete numbered steps.
3) Patch (unified diff or minimal code/config block). Keep it minimal and valid.
4) Commands: list exact shell commands needed (install/build/test). One command per line.
5) Verification: how to confirm the fix (tests, commands, expected logs).

If the input is ambiguous, ask at most 2 targeted questions at the end under "Questions".

Error input:\n\n${inputText}`;

        const placeholderId = `err-${Date.now()}`;
        addMessageWithId("PROTO-BAI", "üõ†Ô∏è Analyzing error‚Ä¶", "ai", placeholderId);
        const text = await callGeminiAPIStream(prompt, placeholderId);
        // Attach action bar with copy helpers
        addActionBarBelow(placeholderId, text || "");
      }

      function activateModule(moduleName) {
        activeModule = moduleName;
        if (moduleName === "python-docs") {
          // Show Python documentation interface
          const message =
            `üêç <strong>Python Documentation Search</strong><br><br>` +
            `You can search Python documentation or get help on specific topics.<br><br>` +
            `<strong>Try these commands:</strong><br>` +
            `‚Ä¢ <span class="command" onclick="handlePythonCommand('python list comprehension')">python list comprehension</span><br>` +
            `‚Ä¢ <span class="command" onclick="handlePythonCommand('help dict')">help dict</span><br>` +
            `‚Ä¢ <span class="command" onclick="handlePythonCommand('python_help os.path')">python_help os.path</span><br><br>` +
            `Or type your own Python documentation query.`;

          addMessage("System", message, "system");

          // Show demo queries as quick buttons
          let demoHtml = `<div class="demo-queries">`;
          demoHtml += `<strong>Example searches:</strong><br>`;
          pythonDocs.demoQueries.forEach((query) => {
            demoHtml += `<button class="demo-query" onclick="handlePythonCommand('python ${query}')">${query}</button> `;
          });
          demoHtml += `<br><br><strong>Help topics:</strong><br>`;
          pythonDocs.demoTopics.forEach((topic) => {
            demoHtml += `<button class="demo-query" onclick="handlePythonCommand('help ${topic}')">${topic}</button> `;
          });
          demoHtml += `</div>`;

          addMessage("System", demoHtml, "system");
        } else if (moduleName === "error-solver") {
          errorSolverActive = true;
          let msg = `üß∞ <strong>Error Solver</strong> activated.<br><br>`;
          msg += `Paste your error log, stack trace, or describe the failure. I will analyze and propose a fix.<br><br>`;
          msg += `<strong>Tips:</strong><br>`;
          msg += `‚Ä¢ Include the exact error message and relevant code/config snippets.<br>`;
          msg += `‚Ä¢ To exit, type <code>exit error solver</code>.<br>`;
          msg += `‚Ä¢ You can also prefix with <code>fix:</code> or <code>error:</code> (works without activating the module).<br>`;
          msg += `<br><strong>Quick examples:</strong><br>`;
          msg += `‚Ä¢ <span class="command" onclick="prefillError('TypeError: Cannot read properties of undefined (reading \"map\") at App.js:42')">React: Cannot read properties of undefined</span><br>`;
          msg += `‚Ä¢ <span class="command" onclick="prefillError('ModuleNotFoundError: No module named \"requests\"')">Python: No module named requests</span><br>`;
          msg += `‚Ä¢ <span class="command" onclick="prefillError('ReferenceError: fetch is not defined in Node.js environment')">Node: fetch is not defined</span><br>`;
          msg += `<button class="back-to-normal" onclick="backToNormal()">Back to Normal</button>`;
          addMessage("System", msg, "system");
        } else {
          // Default module activation
          addMessage("System", `Activated module: ${moduleName}`, "system");
        }
      }

      function backToNormal() {
        // Reset all module-specific flags
        if (errorSolverActive) {
          errorSolverActive = false;
        }
        const prev = activeModule;
        activeModule = null;
        hideTypingIndicator();
        addMessage(
          "System",
          `‚¨Ö Returned to <strong>Normal Mode</strong>${prev ? ` (exited <code>${prev}</code>)` : ""}.`,
          "system"
        );
      }

      // Clipboard utility and action bar for answers
      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          addMessage("System", "‚úÖ Copied to clipboard", "system");
        } catch (e) {
          console.warn("Clipboard failed:", e);
          addMessage("System", "‚ùå Copy failed. Select and copy manually.", "system");
        }
      }

      function extractCommandsFromText(text) {
        const lines = (text || "").split(/\r?\n/);
        const cmdPatterns = [
          /^(npm|pnpm|yarn)\s+(install|add|i)\b.*/i,
          /^(npm|pnpm|yarn)\s+run\s+\w+.*/i,
          /^(npx)\s+.+/i,
          /^(pip3?|python\s+-m\s+pip)\s+install\b.+/i,
          /^pytest(\s+.+)?$/i,
          /^(python|node)\s+\S+.*/i,
          /^git\s+(clone|pull|fetch|submodule\s+update|checkout|apply)\b.+/i,
          /^(docker|docker-compose)\s+.+/i,
        ];
        const cmds = new Set();
        for (const l of lines) {
          const s = l.trim();
          if (!s) continue;
          if (cmdPatterns.some((re) => re.test(s))) cmds.add(s);
          // Also capture lines starting with '$ '
          if (s.startsWith("$ ")) cmds.add(s.slice(2));
        }
        return Array.from(cmds).slice(0, 6); // limit to 6 buttons
      }

      function addActionBarBelow(messageId, text) {
        const msgEl = document.getElementById(messageId);
        if (!msgEl) return;
        const bar = document.createElement("div");
        bar.style.marginTop = "8px";
        bar.style.display = "flex";
        bar.style.flexWrap = "wrap";
        bar.style.gap = "6px";

        const copyAll = document.createElement("button");
        copyAll.textContent = "üìã Copy Answer";
        copyAll.style.padding = "4px 8px";
        copyAll.style.border = "1px solid rgba(0,0,0,0.1)";
        copyAll.style.borderRadius = "8px";
        copyAll.style.background = "#f3f4f6";
        copyAll.style.cursor = "pointer";
        copyAll.onclick = () => copyToClipboard(text);
        bar.appendChild(copyAll);

        const cmds = extractCommandsFromText(text);
        cmds.forEach((c) => {
          const btn = document.createElement("button");
          btn.textContent = `‚ñ∂ ${c}`;
          btn.title = "Copy command";
          btn.style.padding = "4px 8px";
          btn.style.border = "1px solid rgba(0,0,0,0.1)";
          btn.style.borderRadius = "8px";
          btn.style.background = "#eef2ff";
          btn.style.color = "#3730a3";
          btn.style.cursor = "pointer";
          btn.onclick = () => copyToClipboard(c);
          bar.appendChild(btn);
        });

        msgEl.appendChild(bar);
      }

      // Helper to prefill an error sample and send
      function prefillError(text) {
        const input = document.getElementById("textInput");
        input.value = text;
        sendMessage();
      }

      // Handle Python documentation commands from buttons
      function handlePythonCommand(command) {
        const input = document.getElementById("textInput");
        input.value = command;
        sendMessage();
      }

      function getModuleIcon(moduleName) {
        const icons = {
          "File Explorer": "üìÅ",
          "Web Crawler": "üåê",
          "GitHub Search": "üêô",
          "Ticket Booking": "üé´",
          "AI Sync": "ü§ñ",
          "Error Solver": "üîß",
        };
        return icons[moduleName] || "‚öôÔ∏è";
      }

      function changeTheme(theme) {
        const body = document.body;
        const themes = {
          "fairy-tail": "linear-gradient(135deg, #8B5FBF 0%, #60A5FA 100%)",
          "ocean-breeze": "linear-gradient(135deg, #0EA5E9 0%, #06B6D4 100%)",
          "sunset-glow": "linear-gradient(135deg, #F59E0B 0%, #EF4444 100%)",
        };
        body.style.background = themes[theme];
        addMessage(
          "System",
          `üé® Theme changed to: ${theme
            .replace("-", " ")
            .replace(/\b\w/g, (l) => l.toUpperCase())}`,
          "system"
        );
      }

      function changeVoice(voice) {
        addMessage(
          "System",
          `üó£Ô∏è Voice changed to: ${voice
            .replace("-", " ")
            .replace(/\b\w/g, (l) => l.toUpperCase())}`,
          "system"
        );
      }

      async function handleKeyPress(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault(); // Prevent new line in input
          const input = document.getElementById("textInput");
          if (!input) {
            console.error("Input element #textInput not found");
            return;
          }
          const message = input.value.trim();

          if (message === "") return;

          // Disable input while processing
          input.disabled = true;
          // Do not change placeholder to avoid showing "thinking" state

          try {
            // Add user message to chat
            addMessage("You", message, "user");
            input.value = "";

            const lower = message.toLowerCase();
            const identityPhrases = new Set([
              "who are you",
              "who are you?",
              "who created you",
              "tell me about yourself",
              "tell me about yourself?",
              "tell us about yourself",
              "tell us about yourself?",
              "tell me about you",
              "tell me about you?",
              "what is your aim",
              "what is your aim?",
              "what can you do",
              "what can you do?",
            ]);

            // Fast path: identity answer without API
            if (identityPhrases.has(lower)) {
              addMessage("PROTO-BAI", "I am PROTO-AI trained by Sarthak & Dev");
            } else if (
              lower.startsWith("python ") ||
              lower.startsWith("help ") ||
              lower.startsWith("python_help ")
            ) {
              // Handle Python documentation commands
              await processPythonCommand(message);
            } else if (errorSolverActive || message.toLowerCase().startsWith("fix:") || message.toLowerCase().startsWith("error:")) {
              // Error Solver routing
              const clean = message.replace(/^\s*(fix:|error:)\s*/i, "");
              await processErrorSolver(clean || message);
            } else {
              // Stream Gemini API for general queries
              const placeholderId = `msg-${Date.now()}`;
              // single thinking placeholder; streaming will update this same message
              addMessageWithId("PROTO-BAI", "", "ai", placeholderId);
              await callGeminiAPIStream(message, placeholderId);
            }
          } catch (error) {
            console.error("Error:", error);
            addMessage(
              "System",
              "Sorry, there was an error processing your request.",
              "system"
            );
          } finally {
            // Re-enable input
            input.disabled = false;
            input.placeholder = "Type your message...";
            input.focus();

            // Auto-scroll to bottom
            const chatArea = document.querySelector(".chat-area");
            chatArea.scrollTop = chatArea.scrollHeight;
          }
        } else if (event.key === "Enter" && event.shiftKey) {
          // Allow new line with Shift+Enter
          return;
        }
      }

      // Gemini API Configuration
      const GEMINI_API_KEY = "AIzaSyAWNPb5bgI0HgO9Sgsbc4BLuzqD0tzlQ54";
      const GEMINI_API_URL =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

      // Streaming endpoint
      const GEMINI_STREAM_URL =
        "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:streamGenerateContent";

      // Function to call Gemini API
      async function callGeminiAPI(prompt) {
        showTypingIndicator();

        try {
          const response = await fetch(
            `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                contents: [
                  {
                    parts: [
                      {
                        text: prompt,
                      },
                    ],
                  },
                ],
                generationConfig: {
                  maxOutputTokens: 256,
                  temperature: 0.8,
                },
              }),
            }
          );

          if (!response.ok) {
            throw new Error(
              `API request failed with status ${response.status}`
            );
          }

          const data = await response.json();
          hideTypingIndicator();

          if (
            data.candidates &&
            data.candidates[0] &&
            data.candidates[0].content
          ) {
            return data.candidates[0].content.parts[0].text;
          } else {
            throw new Error("Invalid response format from API");
          }
        } catch (error) {
          console.error("Error calling Gemini API:", error);
          hideTypingIndicator();
          return `Sorry, I encountered an error: ${error.message}`;
        }
      }

      // Stream Gemini API and update a message in-place
      async function callGeminiAPIStream(prompt, messageId) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15s safety timeout
        let accumulated = "";
        try {
          const response = await fetch(`${GEMINI_STREAM_URL}?key=${GEMINI_API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            signal: controller.signal,
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: prompt,
                    },
                  ],
                },
              ],
              generationConfig: {
                maxOutputTokens: 256,
                temperature: 0.8,
              },
            }),
          });

          if (!response.ok || !response.body) {
            throw new Error(`Streaming failed with status ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder("utf-8");
          let buffer = "";

          // Initialize placeholder
          addMessageWithId("PROTO-BAI", "", "ai", messageId);

          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            const parts = buffer.split("\n\n");
            buffer = parts.pop();
            for (const chunk of parts) {
              const line = chunk.trim();
              if (!line.startsWith("data:")) continue;
              const jsonStr = line.replace(/^data:\s*/, "");
              if (jsonStr === "[DONE]") continue;
              try {
                const json = JSON.parse(line.replace(/^data: /, ""));
                // Extract delta text based on Gemini stream format
                const parts =
                  json &&
                  json.candidates &&
                  json.candidates[0] &&
                  json.candidates[0].content &&
                  json.candidates[0].content.parts;
                if (Array.isArray(parts)) {
                  const delta = parts
                    .map((p) => (typeof p.text === "string" ? p.text : ""))
                    .join("");
                  accumulated += delta;
                  addMessageWithId("PROTO-BAI", accumulated, "ai", messageId);
                }
              } catch (e) {
                // ignore parse errors for non-JSON control chunks
              }
            }
          }

          // If stream completed but nothing was received, fallback to non-stream call
          if (!accumulated || accumulated.trim() === "") {
            try {
              const fallbackText = await callGeminiAPI(prompt);
              addMessageWithId("PROTO-BAI", fallbackText, "ai", messageId);
              accumulated = fallbackText || "";
            } catch (e) {
              addMessageWithId(
                "System",
                "No response received from streaming API and fallback failed.",
                "system",
                messageId
              );
            }
          }

          hideTypingIndicator();
          clearTimeout(timeout);
          return accumulated || "";
        } catch (err) {
          console.warn("Streaming failed, falling back:", err);
          hideTypingIndicator();
          clearTimeout(timeout);
          // Fallback to non-stream call
          const text = await callGeminiAPI(prompt);
          addMessageWithId("PROTO-BAI", text, "ai", messageId);
          return text;
        }
      }

      // Function to handle sending messages
      async function sendMessage() {
        const input = document.getElementById("textInput");
        if (!input) {
          console.error("Input element #textInput not found");
          return;
        }
        const message = input.value.trim();

        if (message === "") return;

        // Disable input while processing
        input.disabled = true;
        // Do not change placeholder to avoid showing "thinking" state

        try {
          // Add user message to chat
          addMessage("You", message, "user");
          input.value = "";

          // Error Solver routing takes precedence
          if (errorSolverActive || message.toLowerCase().startsWith("fix:") || message.toLowerCase().startsWith("error:")) {
            const clean = message.replace(/^\s*(fix:|error:)\s*/i, "");
            await processErrorSolver(clean || message);
            return;
          }

          const lower = message.toLowerCase();
          const identityPhrases = new Set([
            "who are you",
            "who are you?",
            "tell me about yourself",
            "tell me about yourself?",
            "tell us about yourself",
            "tell us about yourself?",
            "tell me about you",
            "tell me about you?",
            "what is your aim",
            "what is your aim?",
            "what can you do",
            "what can you do?",
          ]);

          if (identityPhrases.has(lower)) {
            addMessage("PROTO-BAI", "i am proto bai trained by sarthak", "ai");
          } else if (
            lower.startsWith("python ") ||
            lower.startsWith("help ") ||
            lower.startsWith("python_help ")
          ) {
            await processPythonCommand(message);
          } else {
            // Stream Gemini API
            const placeholderId = `msg-${Date.now()}`;
            await callGeminiAPIStream(message, placeholderId);
          }
        } catch (error) {
          console.error("Error in sendMessage:", error);
          addMessage(
            "System",
            "Sorry, there was an error processing your request.",
            "system"
          );
        } finally {
          // Re-enable input
          input.disabled = false;
          input.placeholder = "Type your message...";
          input.focus();

          // Auto-scroll to bottom
          const chatArea = document.querySelector(".chat-area");
          chatArea.scrollTop = chatArea.scrollHeight;
        }
      }

      // Initialize with a demo message (immediate)
      setTimeout(() => {
        addMessage(
          "System",
          "Welcome to PROTO-BAI ! Learn new things üòé ",
          "system"
        );
      }, 0);

      // Dynamically size the sidebar mask so items don't peek behind profile
      function updateProfileMask() {
        try {
          const profile = document.querySelector(".profile-section");
          const modules = document.querySelector(".modules-section");
          if (!profile || !modules) return;
          // Height of the profile card + extra buffer for shadows/rounded corners
          const h = profile.offsetHeight + 32;
          modules.style.setProperty("--profile-mask", h + "px");
        } catch (_) {}
      }

      // Observe size/content changes to profile to recompute mask
      const profEl = document.querySelector(".profile-section");
      if (profEl && "ResizeObserver" in window) {
        const ro = new ResizeObserver(updateProfileMask);
        ro.observe(profEl);
      }

      // Recompute on events that could change layout
      window.addEventListener("load", updateProfileMask);
      window.addEventListener("resize", updateProfileMask);
      document.addEventListener("DOMContentLoaded", updateProfileMask);
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(updateProfileMask).catch(() => {});
      }
      // Apply once right away
      updateProfileMask();
    </script>
  </body>
</html>
